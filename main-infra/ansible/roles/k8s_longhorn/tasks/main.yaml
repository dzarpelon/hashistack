---
# Deploy Longhorn storage system

- name: Add Longhorn Helm repository
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
  delegate_to: localhost
  become: false

- name: Create Longhorn namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: longhorn-system
  delegate_to: localhost
  become: false

- name: Install Longhorn via Helm
  kubernetes.core.helm:
    name: longhorn
    chart_ref: longhorn/longhorn
    release_namespace: longhorn-system
    create_namespace: false
    wait: true
    wait_timeout: 10m
    values:
      defaultSettings:
        defaultDataPath: /var/lib/longhorn
        replicaAutoBalance: best-effort
      persistence:
        defaultClass: true
        defaultClassReplicaCount: 2
      ingress:
        enabled: false
  delegate_to: localhost
  become: false

- name: Wait for Longhorn manager to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    name: longhorn-driver-deployer
    namespace: longhorn-system
  register: k8s_longhorn_status
  until: k8s_longhorn_status.resources[0].status.readyReplicas | default(0) >= 1
  retries: 60
  delay: 10
  delegate_to: localhost
  become: false

- name: Display Longhorn installation status
  ansible.builtin.debug:
    msg: |
      Longhorn storage system has been installed successfully!

      Default StorageClass: longhorn (with 2 replicas)
      Data path: /var/lib/longhorn on each node

      Longhorn UI can be accessed by port-forwarding:
        kubectl port-forward -n longhorn-system svc/longhorn-frontend 8080:80
      Then visit: http://localhost:8080
