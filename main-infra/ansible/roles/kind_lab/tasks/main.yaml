---
- name: Manage KIND lab
  block:
    ##########################################################################
    # DESTROY MODE
    ##########################################################################
    - name: "Destroy KIND cluster if state=absent"
      when: state == "absent"
      block:
        - name: Delete KIND cluster
          become: false
          ansible.builtin.command: kind delete cluster --name {{ cluster_name }}
          ignore_errors: true
          register: kind_delete
          changed_when: "'Deleted' in kind_delete.stdout"

        - name: Remove macOS resolver file
          become: true
          ansible.builtin.file:
            path: "/etc/resolver/{{ dns_domain }}"
            state: absent
          when: ansible_facts['os_family'] == "Darwin"

        - name: Remove dnsmasq container
          become: false
          ansible.builtin.shell: docker rm -f {{ dnsmasq_container_name }} >/dev/null 2>&1 || true
          changed_when: false

        - name: Clean up Docker networks and volumes
          become: false
          ansible.builtin.shell: |
            docker network prune -f && docker volume prune -f
          changed_when: false

        - name: Show destruction summary
          ansible.builtin.debug:
            msg: |
              ğŸ§¹ KIND cluster '{{ cluster_name }}' destroyed
              ğŸ§­ DNS proxy container removed
              ğŸ§¼ Resolver /etc/resolver/{{ dns_domain }} deleted
              ğŸ§± Docker networks/volumes cleaned

    ##########################################################################
    # CREATE MODE
    ##########################################################################
    - name: "Create KIND cluster if state=present"
      when: state == "present"
      block:
        # ----------------------------------------------------------
        # KIND + kubectl install
        # ----------------------------------------------------------
        - name: Ensure kind is installed
          ansible.builtin.command: |
            bash -c 'if ! command -v kind >/dev/null; then \
              curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-$(uname)-amd64 && \
              chmod +x ./kind && mv ./kind /usr/local/bin/kind; fi'
          args:
            creates: /usr/local/bin/kind

        - name: Ensure kubectl is installed
          ansible.builtin.command: |
            bash -c 'if ! command -v kubectl >/dev/null; then \
              curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/$(uname | tr "[:upper:]" "[:lower:]")/amd64/kubectl" && \
              chmod +x kubectl && mv kubectl /usr/local/bin/kubectl; fi'
          args:
            creates: /usr/local/bin/kubectl

        - name: Create kind cluster config
          ansible.builtin.template:
            src: templates/kind-config.yaml.j2
            dest: "{{ kind_config_path }}"

        - name: Check existing kind clusters
          ansible.builtin.command: kind get clusters
          register: kind_lab_clusters
          changed_when: false
          failed_when: false

        - name: Create KIND cluster
          ansible.builtin.command: kind create cluster --name {{ cluster_name }} --config {{ kind_config_path }}
          when: cluster_name not in kind_lab_clusters.stdout

        - name: Wait for cluster readiness
          ansible.builtin.command: kubectl cluster-info --context kind-{{ cluster_name }}
          register: kind_lab_cluster_ready
          retries: 10
          delay: 10
          until: kind_lab_cluster_ready.rc == 0

        # ----------------------------------------------------------
        # METALLB
        # ----------------------------------------------------------
        - name: Install MetalLB
          ansible.builtin.command: >
            kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml
          register: kind_lab_metallb_apply
          changed_when: "'created' in kind_lab_metallb_apply.stdout or 'configured' in kind_lab_metallb_apply.stdout"

        - name: Wait for MetalLB pods
          ansible.builtin.shell: |
            kubectl wait --namespace metallb-system \
              --for=condition=ready pod \
              --selector=component=controller \
              --timeout=120s
          changed_when: false

        - name: Configure MetalLB pool and L2 advertisement
          ansible.builtin.shell: |
            cat <<EOF | kubectl apply -f -
            apiVersion: metallb.io/v1beta1
            kind: IPAddressPool
            metadata:
              name: default-address-pool
              namespace: metallb-system
            spec:
              addresses:
              - {{ metallb_ip_range }}
            ---
            apiVersion: metallb.io/v1beta1
            kind: L2Advertisement
            metadata:
              name: l2-advertisement
              namespace: metallb-system
            spec: {}
            EOF
          changed_when: false

        # ----------------------------------------------------------
        # TRAEFIK
        # ----------------------------------------------------------
        - name: Ensure pip tooling (packaging) is available in Ansible Python
          ansible.builtin.command: "{{ ansible_python.executable }} -m pip install --upgrade pip packaging"
          changed_when: false

        - name: Install PyYAML and kubernetes python client into Ansible Python
          ansible.builtin.command: "{{ ansible_python.executable }} -m pip install pyyaml kubernetes"
          changed_when: false

        - name: Add Traefik Helm repo
          community.kubernetes.helm_repository:
            name: traefik
            repo_url: https://helm.traefik.io/traefik

        - name: Install Traefik ingress controller
          community.kubernetes.helm:
            name: traefik
            chart_ref: traefik/traefik
            release_namespace: traefik
            create_namespace: true
            values:
              ingressClass:
                enabled: true
                isDefaultClass: true
              ports:
                web:
                  port: 80
                  redirectTo: websecure
                websecure:
                  port: 443
              service:
                type: LoadBalancer
              additionalArguments:
                - "--api.dashboard=true"
                - "--api.insecure=false"
                - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
                - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
                - "--entrypoints.websecure.http.tls=true"
              ingressRoute:
                dashboard:
                  enabled: true

        # ----------------------------------------------------------
        # COREDNS PATCH
        # ----------------------------------------------------------
        - name: Patch CoreDNS for {{ dns_domain }}
          ansible.builtin.shell: |
            kubectl -n kube-system get configmap coredns -o yaml \
            | sed '/^data:/,/^ *$/ s/^.*$/&\n    {{ dns_domain }}:53 {\n        log\n        errors\n        forward . 127.0.0.1\n    }\n/' \
            | kubectl apply -f -
          changed_when: false

        # ----------------------------------------------------------
        # DNSMASQ ON HOST
        # ----------------------------------------------------------
        - name: Get CoreDNS ClusterIP
          ansible.builtin.command: kubectl get svc -n kube-system kube-dns -o jsonpath='{.spec.clusterIP}'
          register: kind_lab_coredns_ip
          changed_when: false

        - name: Render dnsmasq configuration
          ansible.builtin.template:
            src: files/dnsmasq.conf.j2
            dest: /tmp/dnsmasq.conf

        - name: Remove any existing dnsmasq container
          ansible.builtin.shell: docker rm -f {{ dnsmasq_container_name }} >/dev/null 2>&1 || true
          changed_when: false

        - name: Run portable dnsmasq container (host network)
          ansible.builtin.shell: |
            docker run -d \
              --name {{ dnsmasq_container_name }} \
              --restart unless-stopped \
              --network host \
              -v /tmp/dnsmasq.conf:/etc/dnsmasq.conf:ro \
              --platform linux/amd64 \
              {{ dnsmasq_image }} -k
          args:
            executable: /bin/bash
          register: kind_lab_dnsmasq_run
          changed_when: "'Started' in kind_lab_dnsmasq_run.stdout or 'Created' in kind_lab_dnsmasq_run.stdout"

        - name: Create macOS resolver for {{ dns_domain }}
          become: true
          ansible.builtin.copy:
            dest: "/etc/resolver/{{ dns_domain }}"
            content: |
              nameserver 127.0.0.1
          when: ansible_facts['os_family'] == "Darwin"

        # ----------------------------------------------------------
        # SUMMARY
        # ----------------------------------------------------------
        - name: Summary
          ansible.builtin.debug:
            msg: |
              âœ… KIND cluster '{{ cluster_name }}' created
              ğŸŒ Traefik: https://traefik.{{ dns_domain }}/dashboard/
              âš™ï¸ MetalLB IP range: {{ metallb_ip_range }}
              ğŸ§­ CoreDNS IP: {{ kind_lab_coredns_ip.stdout }}
              ğŸ§© dnsmasq container: {{ dnsmasq_container_name }} (127.0.0.1:53)
              ğŸ“˜ macOS resolver: /etc/resolver/{{ dns_domain }}
