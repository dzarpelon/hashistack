---
# Deploy Traefik Ingress Controller

- name: Add Traefik Helm repository
  kubernetes.core.helm_repository:
    name: traefik
    repo_url: https://traefik.github.io/charts
  delegate_to: localhost
  become: false
  failed_when: false

- name: Create Traefik namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: traefik-system
  delegate_to: localhost
  become: false

- name: Install Traefik via Helm
  kubernetes.core.helm:
    name: traefik
    chart_ref: traefik/traefik
    release_namespace: traefik-system
    create_namespace: false
    wait: true
    wait_timeout: 10m
    values:
      deployment:
        replicas: 2
      service:
        type: LoadBalancer
        annotations:
          external-dns.alpha.kubernetes.io/hostname: traefik.lab.dzarpelon.com
      ports:
        web:
          port: 8000
          exposedPort: 80
          expose:
            default: true
        websecure:
          port: 8443
          exposedPort: 443
          expose:
            default: true
          tls:
            enabled: true
      ingressRoute:
        dashboard:
          enabled: true
          matchRule: Host(`traefik.lab.dzarpelon.com`)
          entryPoints: ["web"]
      logs:
        general:
          level: INFO
        access:
          enabled: true
      providers:
        kubernetesCRD:
          enabled: true
          allowCrossNamespace: true
        kubernetesIngress:
          enabled: true
          publishedService:
            enabled: true
  delegate_to: localhost
  become: false

- name: Wait for Traefik deployment to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    name: traefik
    namespace: traefik-system
  register: k8s_traefik_status
  until: k8s_traefik_status.resources[0].status.readyReplicas | default(0) >= 2
  retries: 60
  delay: 10
  delegate_to: localhost
  become: false

- name: Get Traefik LoadBalancer IP
  kubernetes.core.k8s_info:
    kind: Service
    name: traefik
    namespace: traefik-system
  register: k8s_traefik_svc
  delegate_to: localhost
  become: false

# Dashboard Authentication Setup
- name: Check if htpasswd command is available
  ansible.builtin.command: which htpasswd
  register: k8s_traefik_htpasswd_check
  delegate_to: localhost
  become: false
  changed_when: false
  failed_when: false

- name: Generate htpasswd hash using htpasswd command
  ansible.builtin.shell: |
    htpasswd -nbB {{ dashboard_admin_user }} '{{ dashboard_admin_password }}' | base64
  register: k8s_traefik_htpasswd
  delegate_to: localhost
  become: false
  no_log: true
  changed_when: false
  when: k8s_traefik_htpasswd_check.rc == 0

- name: Generate htpasswd hash using Python (fallback)
  ansible.builtin.shell: |
    python3 -c "
    import subprocess
    import base64
    # Use openssl for bcrypt hash
    result = subprocess.run(['openssl', 'passwd', '-apr1', '{{ dashboard_admin_password }}'], 
                          capture_output=True, text=True)
    hash = result.stdout.strip()
    htpasswd_line = '{{ dashboard_admin_user }}:' + hash
    encoded = base64.b64encode(htpasswd_line.encode()).decode()
    print(encoded)
    "
  register: k8s_traefik_htpasswd_python
  delegate_to: localhost
  become: false
  no_log: true
  changed_when: false
  when: k8s_traefik_htpasswd_check.rc != 0

- name: Set htpasswd variable
  ansible.builtin.set_fact:
    k8s_traefik_htpasswd_final: "{{ k8s_traefik_htpasswd.stdout if k8s_traefik_htpasswd_check.rc == 0 else k8s_traefik_htpasswd_python.stdout }}"
  no_log: true

- name: Create Traefik dashboard auth Secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: traefik-dashboard-auth
        namespace: traefik-system
      type: Opaque
      data:
        users: "{{ k8s_traefik_htpasswd_final }}"
  delegate_to: localhost
  become: false
  no_log: true

- name: Apply Traefik dashboard auth Middleware
  kubernetes.core.k8s:
    state: present
    src: "{{ playbook_dir }}/../../manifests/ingress/traefik-dashboard-auth-middleware.yaml"
  delegate_to: localhost
  become: false

- name: Update Traefik IngressRoute to use authentication
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: dashboard
        namespace: traefik-system
      spec:
        entryPoints:
          - web
        routes:
          - match: Host(`traefik.lab.dzarpelon.com`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))
            kind: Rule
            middlewares:
              - name: dashboard-auth
                namespace: traefik-system
            services:
              - name: api@internal
                kind: TraefikService
  delegate_to: localhost
  become: false

- name: Create Longhorn dashboard auth Secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: longhorn-dashboard-auth
        namespace: longhorn-system
      type: Opaque
      data:
        users: "{{ k8s_traefik_htpasswd_final }}"
  delegate_to: localhost
  become: false
  no_log: true

- name: Apply Longhorn dashboard auth Middleware
  kubernetes.core.k8s:
    state: present
    src: "{{ playbook_dir }}/../../manifests/ingress/longhorn-dashboard-auth-middleware.yaml"
  delegate_to: localhost
  become: false

- name: Apply Longhorn dashboard Ingress
  kubernetes.core.k8s:
    state: present
    src: "{{ playbook_dir }}/../../manifests/ingress/longhorn-dashboard.yaml"
  delegate_to: localhost
  become: false

- name: Display Traefik installation status
  ansible.builtin.debug:
    msg: |
      Traefik Ingress Controller has been installed successfully!

      LoadBalancer IP: {{ k8s_traefik_svc.resources[0].status.loadBalancer.ingress[0].ip }}
      Dashboard URL: http://traefik.lab.dzarpelon.com/dashboard/
      Longhorn Dashboard URL: http://longhorn.lab.dzarpelon.com

      Dashboard Authentication:
        Username: {{ dashboard_admin_user }}
        Password: (see ansible/group_vars/all/secrets.yaml)

      Traefik is ready to handle Ingress resources!

      Entry Points:
        - HTTP (web): port 80
        - HTTPS (websecure): port 443
