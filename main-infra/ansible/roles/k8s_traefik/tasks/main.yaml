---
# Deploy Traefik Ingress Controller

- name: Add Traefik Helm repository
  kubernetes.core.helm_repository:
    name: traefik
    repo_url: https://traefik.github.io/charts
  delegate_to: localhost
  become: false
  failed_when: false

- name: Create Traefik namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: traefik-system
  delegate_to: localhost
  become: false

- name: Install Traefik via Helm
  kubernetes.core.helm:
    name: traefik
    chart_ref: traefik/traefik
    release_namespace: traefik-system
    create_namespace: false
    wait: true
    wait_timeout: 10m
    values:
      deployment:
        replicas: 2
      service:
        type: LoadBalancer
        annotations:
          external-dns.alpha.kubernetes.io/hostname: traefik.lab.dzarpelon.com
      ports:
        web:
          port: 8000
          exposedPort: 80
          expose:
            default: true
        websecure:
          port: 8443
          exposedPort: 443
          expose:
            default: true
          tls:
            enabled: true
      ingressRoute:
        dashboard:
          enabled: true
          matchRule: Host(`traefik.lab.dzarpelon.com`)
          entryPoints: ["web"]
      logs:
        general:
          level: INFO
        access:
          enabled: true
      providers:
        kubernetesCRD:
          enabled: true
          allowCrossNamespace: true
        kubernetesIngress:
          enabled: true
          publishedService:
            enabled: true
  delegate_to: localhost
  become: false

- name: Wait for Traefik deployment to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    name: traefik
    namespace: traefik-system
  register: k8s_traefik_status
  until: k8s_traefik_status.resources[0].status.readyReplicas | default(0) >= 2
  retries: 60
  delay: 10
  delegate_to: localhost
  become: false

- name: Get Traefik LoadBalancer IP
  kubernetes.core.k8s_info:
    kind: Service
    name: traefik
    namespace: traefik-system
  register: k8s_traefik_svc
  delegate_to: localhost
  become: false

- name: Apply Longhorn dashboard Ingress
  kubernetes.core.k8s:
    state: present
    src: "{{ playbook_dir }}/../../manifests/ingress/longhorn-dashboard.yaml"
  delegate_to: localhost
  become: false

- name: Display Traefik installation status
  ansible.builtin.debug:
    msg: |
      Traefik Ingress Controller has been installed successfully!

      LoadBalancer IP: {{ k8s_traefik_svc.resources[0].status.loadBalancer.ingress[0].ip }}
      Dashboard URL: http://traefik.lab.dzarpelon.com
      Longhorn Dashboard URL: http://longhorn.lab.dzarpelon.com

      Traefik is ready to handle Ingress resources!

      Entry Points:
        - HTTP (web): port 80
        - HTTPS (websecure): port 443
