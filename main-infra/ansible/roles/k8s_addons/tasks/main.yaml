---
- name: Install Kubernetes add-ons
  block:
    - name: Install MetalLB namespace
      ansible.builtin.shell: |
        kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml
      register: k8s_addons_metallb_install
      changed_when: "'created' in k8s_addons_metallb_install.stdout or 'configured' in k8s_addons_metallb_install.stdout"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Wait for MetalLB controller to be ready
      ansible.builtin.shell: |
        kubectl wait --namespace metallb-system \
          --for=condition=ready pod \
          --selector=app=metallb \
          --timeout=120s
      register: k8s_addons_metallb_wait
      changed_when: false
      retries: 3
      delay: 10
      until: k8s_addons_metallb_wait.rc == 0
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Create MetalLB IP address pool configuration
      ansible.builtin.copy:
        content: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: homelab-pool
            namespace: metallb-system
          spec:
            addresses:
            - 192.168.100.150-192.168.100.250
        dest: /tmp/metallb-ippool.yaml
        mode: '0644'

    - name: Create MetalLB L2Advertisement configuration
      ansible.builtin.copy:
        content: |
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: homelab-l2
            namespace: metallb-system
          spec:
            ipAddressPools:
            - homelab-pool
        dest: /tmp/metallb-l2.yaml
        mode: '0644'

    - name: Apply MetalLB IP address pool
      ansible.builtin.shell: |
        kubectl apply -f /tmp/metallb-ippool.yaml
      register: k8s_addons_metallb_ippool
      changed_when: "'created' in k8s_addons_metallb_ippool.stdout or 'configured' in k8s_addons_metallb_ippool.stdout"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Apply MetalLB L2Advertisement
      ansible.builtin.shell: |
        kubectl apply -f /tmp/metallb-l2.yaml
      register: k8s_addons_metallb_l2
      changed_when: "'created' in k8s_addons_metallb_l2.stdout or 'configured' in k8s_addons_metallb_l2.stdout"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Display MetalLB installation status
      ansible.builtin.debug:
        msg: |
          MetalLB has been installed successfully!
          IP Address Pool: 192.168.100.150-192.168.100.250
          Mode: Layer 2
          
          You can now create LoadBalancer services and they will automatically
          receive external IPs from the configured range.
